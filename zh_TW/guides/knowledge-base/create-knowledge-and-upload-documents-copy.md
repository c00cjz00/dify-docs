# 創建知識庫&上傳文檔

### 1 創建知識庫

在 Dify 主導航欄中點擊知識庫，在該頁面你可以看到已有的知識庫。你可以點擊 **創建知識庫** 進入創建嚮導：

<figure><img src="../../.gitbook/assets/image (173).png" alt=""><figcaption><p>創建知識庫</p></figcaption></figure>

* 如果你已經準備好了文件，可以從上傳文件開始;
* 如果你還沒有準備好文檔，可以先創建一個空數據集;

<figure><img src="../../.gitbook/assets/image (191).png" alt=""><figcaption><p>創建知識庫</p></figcaption></figure>

{% hint style="info" %}
如果你在創建數據集時選擇了使用外部數據源，該知識庫的類型不可更改。這是為了防止單一知識庫存在多數據源而造成的管理困難。如果你需要使用多個數據源，建議創建多個知識庫。
{% endhint %}

***

### **2 上傳文檔**

**知識庫內上傳文檔的步驟：**

1. 從本地選擇你需要上傳的文檔；
2. 分段與清洗，預覽效果；
3. 選擇及配置索引和檢索策略；
4. 等待分段嵌入；
5. 完成上傳，可以在應用中使用了🎉

**上傳文檔的限制：**

* 單文檔的上傳大小限制為 15MB；
* 單次批量上傳文件個數上限為 20 個；
* SaaS 版本的不同[訂閱計劃](https://dify.ai/pricing)限定了**批量上傳個數、文檔上傳總數、向量存儲**；

### 3 分段與清洗

**分段**：大語言模型存在有限的上下文窗口，通常需要將整段文本進行分段處理後，將與用戶問題關聯度最高的幾個段落召回，即分段 TopK 召回模式。此外，在用戶問題與文本分段進行語義匹配時，合適的分段大小將有助於匹配關聯性最高的文本內容，減少信息噪音。

**清洗：** 為了保證文本召回的效果，通常需要在將數據傳入模型之前對其進行清理。例如，如果輸出中存在不需要的字符或者空行，可能會影響問題回覆的質量。為了幫助用戶解決這個問題， Dify 提供了多種清洗方法，可以幫助用戶在將輸出發送到下游應用程序之前對其進行清理。

分段與清洗支持兩種配置策略

* 自動模式（即將下線）
* 自定義模式

<figure><img src="../../.gitbook/assets/image (177).png" alt=""><figcaption></figcaption></figure>

在自定義模式下，用戶可以根據不同的文檔格式和場景要求來配置文本的分段和清洗策略。

**分段規則：**

* 分段標識符，設置標識符如“\n”，系統將在文本中出現該標識符時分段；
* 分段最大長度，根據分段的文本字符數最大上限來進行分段，超出該長度時將強制分段；
* 分段重疊長度，設置分段間的重疊字符數，建議設置為分段長度的 10-25%，有助於保留分段之間的語義相關性，在多分段召回時提高召回效果。

**預處理規則：**

* 替換連續的空格、換行符和製表符；
* 刪除所有 URL 和電子郵件地址；

***

### 4 ETL 可選配置

在 RAG 的生產級應用中，為了獲得更好的數據召回效果，需要對多源數據進行預處理和清洗，即 ETL （_extract, transform, load_）。為了增強非結構化/半結構化數據的預處理能力，Dify 支持了可選的 ETL 方案：**Dify ETL** 和[ ](https://docs.unstructured.io/welcome)[**Unstructured ETL** ](https://unstructured.io/)。

> Unstructured 能夠高效地提取並轉換您的數據為乾淨的數據用於後續的步驟。

Dify 各版本的 ETL 方案選擇：

* SaaS 版不可選，默認使用 Unstructured ETL；
* 社區版可選，默認使用 Dify ETL ，可通過[環境變量](../../getting-started/install-self-hosted/environments.md#zhi-shi-ku-pei-zhi)開啟 Unstructured ETL；

文件解析支持格式的差異：

| DIFY ETL                                       | Unstructured ETL                                                         |
| ---------------------------------------------- | ------------------------------------------------------------------------ |
| txt、markdown、md、pdf、html、htm、xlsx、xls、docx、csv | txt、markdown、md、pdf、html、htm、xlsx、xls、docx、csv、eml、msg、pptx、ppt、xml、epub |

{% hint style="info" %}
不同的 ETL 方案在文件提取效果的方面也會存在差異，想了解更多關於 Unstructured ETL 的數據處理方式，請參考[官方文檔](https://docs.unstructured.io/open-source/core-functionality/partitioning)。
{% endhint %}

***

### 5 索引方式

你需要選擇文本的**索引方式**來指定數據的匹配方式，索引策略往往與檢索方式相關，你需要根據場景需求來選擇合適的索引方式。

**高質量模式：** 將調用 OpenAI 的嵌入接口進行處理，以在用戶查詢時提供更高的準確度。

**經濟模式：** 會使用關鍵詞索引方式，降低了準確度但無需花費 Token。

**Q\&A 模式（僅社區版支持）：** Q\&A 分段模式功能，與上述普通的「Q to P」（問題匹配文本段落）匹配模式不同，它是採用「Q to Q」（問題匹配問題）匹配工作，在文檔經過分段後，經過總結為每一個分段生成 Q\&A 匹配對，當用戶提問時，系統會找出與之最相似的問題，然後返回對應的分段作為答案。這種方式更加精確，因為它直接針對用戶問題進行匹配，可以更準確地獲取用戶真正需要的信息。

在知識庫上傳文檔時，系統將對文本進行分段，使得用戶的提問（輸入）能匹配到相關的文本段落（Q to P），最後輸出結果。

> 問題文本是具有完整語法結構的自然語言，而不是文檔檢索任務中的一些關鍵字，所以 Q to Q （問題匹配問題）的模式會令語意和匹配更加清晰，並同時滿足一些高頻和高相似度問題的提問場景。

<figure><img src="../../.gitbook/assets/image (110).png" alt=""><figcaption><p>Q&#x26;A 分段模式下被總結成多個 Q&#x26;A 對的文本</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (109).png" alt=""><figcaption><p>Q to P 與 Q to Q 的索引模式區別</p></figcaption></figure>

***

### 6 檢索設置

在高質量索引模式下，Dify 提供了 3 種檢索方案：

* **向量檢索**，通過生成查詢嵌入並查詢與其向量表示最相似的文本分段。
* **全文檢索**，索引文檔中的所有詞彙，從而允許用戶查詢任意詞彙，並返回包含這些詞彙的文本片段。
* **混合檢索**，同時執行全文檢索和向量檢索，並附加重排序步驟，從兩類查詢結果中選擇匹配用戶問題的最佳結果，需配置 Rerank 模型 API。

三種檢索方式的具體配置如下：

#### **向量檢索**

定義：通過生成查詢嵌入並查詢與其向量表示最相似的文本分段。

<figure><img src="../../.gitbook/assets/image (116).png" alt="" width="563"><figcaption><p>向量檢索設置</p></figcaption></figure>

TopK：用於篩選與用戶問題相似度最高的文本片段。系統同時會根據選用模型上下文窗口大小動態調整片段數量。系統默認值為 3 。數值越高，預期被召回的文本分段數量越多。

Score 閾值：用於設置文本片段篩選的相似度閾值，即：只召回超過設置分數的文本片段。系統默認關閉該設置，即不會對召回的文本片段相似值過濾。打開後默認值為 0.5。數值越高，預期被召回的文本數量越少。

Rerank 模型：你可以在“模型供應商”頁面配置 Rerank 模型的 API 祕鑰之後，在檢索設置中打開“Rerank 模型”，系統會在語義檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設置 Rerank 模型後，TopK 和 Score 閾值設置僅在 Rerank 步驟生效。

#### **全文檢索**

定義：索引文檔中的所有詞彙，從而允許用戶查詢任意詞彙，並返回包含這些詞彙的文本片段。

<figure><img src="../../.gitbook/assets/image (122).png" alt="" width="563"><figcaption><p>全文檢索設置</p></figcaption></figure>

TopK：用於篩選與用戶問題相似度最高的文本片段。系統同時會根據選用模型上下文窗口大小動態調整片段數量。系統默認值為 3 。數值越高，預期被召回的文本分段數量越多。

Score 閾值：用於設置文本片段篩選的相似度閾值，即：只召回超過設置分數的文本片段。系統默認關閉該設置，即不會對召回的文本片段相似值過濾。打開後默認值為 0.5。數值越高，預期被召回的文本數量越少。

Rerank 模型：你可以在“模型供應商”頁面配置 Rerank 模型的 API 祕鑰之後，在檢索設置中打開“Rerank 模型”，系統會在全文檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設置 Rerank 模型後，TopK 和 Score 閾值設置僅在 Rerank 步驟生效。

#### 混合檢索

定義：同時執行全文檢索和向量檢索，並應用重排序步驟，從兩類查詢結果中選擇匹配用戶問題的最佳結果。在此模式下可以指定“權重設置”（無需配置 Rerank 模型 API）或選擇 Rerank 模型進行檢索。

<figure><img src=".../../../../../img/zh-create-knowledge.png" alt="" width="563"><figcaption><p>混合檢索設置</p></figcaption></figure>

權重設置：允許用戶賦予語義優先和關鍵詞優先自定義的權重。關鍵詞檢索指的是在知識庫內進行全文檢索（Full Text Search），語義檢索指的是在知識庫內進行向量檢索（Vector Search）。

- **語義值為 1**

  僅啟用語義檢索模式。藉助 Embedding 模型，即便知識庫中沒有出現查詢中的確切詞彙，也能通過計算向量距離的方式提高搜索的深度，返回正確內容。此外，當需要處理多語言內容時，語義檢索能夠捕捉不同語言之間的意義轉換，提供更加準確的跨語言搜索結果。

  > 語義檢索指的是比對用戶問題與知識庫內容中的向量距離。距離越近，匹配的概率越大。參考閱讀：[《Dify：Embedding 技術與 Dify 數據集設計/規劃》](https://mp.weixin.qq.com/s/vmY_CUmETo2IpEBf1nEGLQ)。

- **關鍵詞值為 1**
  
  僅啟用關鍵詞檢索模式。通過用戶輸入的信息文本在知識庫全文匹配，適用於用戶知道確切的信息或術語的場景。該方法所消耗的計算資源較低，適合在大量文檔的知識庫內快速檢索。

- **自定義關鍵詞和語義權重**

    除了僅啟用語義檢索或關鍵詞檢索模式，我們還提供了靈活的自定義權重設置。你可以通過不斷調試二者的權重，找到符合業務場景的最佳權重比例。

TopK：用於篩選與用戶問題相似度最高的文本片段。系統同時會根據選用模型上下文窗口大小動態調整片段數量。系統默認值為 3 。數值越高，預期被召回的文本分段數量越多。

Score 閾值：用於設置文本片段篩選的相似度閾值，即：只召回超過設置分數的文本片段。系統默認關閉該設置，即不會對召回的文本片段相似值過濾。打開後默認值為 0.5。數值越高，預期被召回的文本數量越少。

Rerank 模型：你可以在“模型供應商”頁面配置 Rerank 模型的 API 祕鑰之後，在檢索設置中打開“Rerank 模型”，系統會在混合檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設置 Rerank 模型後，TopK 和 Score 閾值設置僅在 Rerank 步驟生效。
