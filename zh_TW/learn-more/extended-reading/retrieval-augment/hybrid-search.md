# 混合檢索

### 為什麼需要混合檢索？

RAG 檢索環節中的主流方法是向量檢索，即語義相關度匹配的方式。技術原理是通過將外部知識庫的文檔先拆分為語義完整的段落或句子，並將其轉換（Embedding）為計算機能夠理解的一串數字表達（多維向量），同時對用戶問題進行同樣的轉換操作。

計算機能夠發現用戶問題與句子之間細微的語義相關性，比如 “貓追逐老鼠” 和 “小貓捕獵老鼠” 的語義相關度會高於 “貓追逐老鼠” 和 “我喜歡吃火腿” 之間的相關度。在將相關度最高的文本內容查找到後，RAG 系統會將其作為用戶問題的上下文一起提供給大模型，幫助大模型回答問題。

除了能夠實現複雜語義的文本查找，向量檢索還有其他的優勢：

* 相近語義理解（如老鼠/捕鼠器/奶酪，谷歌/必應/搜索引擎）
* 多語言理解（跨語言理解，如輸入中文匹配英文）
* 多模態理解（支持文本、圖像、音視頻等的相似匹配）
* 容錯性（處理拼寫錯誤、模糊的描述）

雖然向量檢索在以上情景中具有明顯優勢，但有某些情況效果不佳。比如：

* 搜索一個人或物體的名字（例如，伊隆·馬斯克，iPhone 15）
* 搜索縮寫詞或短語（例如，RAG，RLHF）
* 搜索 ID（例如， `gpt-3.5-turbo` ， `titan-xlarge-v1.01` ）

而上面這些的缺點恰恰都是傳統關鍵詞搜索的優勢所在，傳統關鍵詞搜索擅長：

* 精確匹配（如產品名稱、姓名、產品編號）
* 少量字符的匹配（通過少量字符進行向量檢索時效果非常不好，但很多用戶恰恰習慣只輸入幾個關鍵詞）
* 傾向低頻詞彙的匹配（低頻詞彙往往承載了語言中的重要意義，比如“你想跟我去喝咖啡嗎？”這句話中的分詞，“喝”“咖啡”會比“你”“想”“嗎”在句子中承載更重要的含義）

對於大多數文本搜索的情景，首要的是確保潛在最相關結果能夠出現在候選結果中。向量檢索和關鍵詞檢索在檢索領域各有其優勢。混合搜索正是結合了這兩種搜索技術的優點，同時彌補了兩方的缺點。

在混合檢索中，你需要在數據庫中提前建立向量索引和關鍵詞索引，在用戶問題輸入時，分別通過兩種檢索器在文檔中檢索出最相關的文本。

<figure><img src="../../../.gitbook/assets/image (178).png" alt="" width="563"><figcaption><p>混合檢索</p></figcaption></figure>

“混合檢索”實際上並沒有明確的定義，本文以向量檢索和關鍵詞檢索的組合為示例。如果我們使用其他搜索算法的組合，也可以被稱為“混合檢索”。比如，我們可以將用於檢索實體關係的知識圖譜技術與向量檢索技術結合。

不同的檢索系統各自擅長尋找文本（段落、語句、詞彙）之間不同的細微聯繫，這包括了精確關係、語義關係、主題關係、結構關係、實體關係、時間關係、事件關係等。可以說沒有任何一種檢索模式能夠適用全部的情景。**混合檢索通過多個檢索系統的組合，實現了多個檢索技術之間的互補。**

### **向量檢索**

定義：通過生成查詢嵌入並查詢與其向量表示最相似的文本分段。

<figure><img src="../../../.gitbook/assets/image (167).png" alt="" width="563"><figcaption><p>向量檢索設置</p></figcaption></figure>

**TopK：** 用於篩選與用戶問題相似度最高的文本片段。系統同時會根據選用模型上下文窗口大小動態調整片段數量。系統默認值為 3 。

**Score 閾值：** 用於設置文本片段篩選的相似度閾值，即：只召回超過設置分數的文本片段。系統默認關閉該設置，即不會對召回的文本片段相似值過濾。打開後默認值為 0.5 。

**Rerank 模型：** 你可以在“模型供應商”頁面配置 Rerank 模型的 API 祕鑰之後，在檢索設置中打開“Rerank 模型”，系統會在語義檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設置 Rerank 模型後，TopK 和 Score 閾值設置僅在 Rerank 步驟生效。

### **全文檢索**

定義：索引文檔中的所有詞彙，從而允許用戶查詢任意詞彙，並返回包含這些詞彙的文本片段。

<figure><img src="../../../.gitbook/assets/image (173).png" alt="" width="563"><figcaption><p>全文檢索設置</p></figcaption></figure>

**TopK：** 用於篩選與用戶問題相似度最高的文本片段。系統同時會根據選用模型上下文窗口大小動態調整片段數量。系統默認值為 3 。

**Rerank 模型：** 你可以在“模型供應商”頁面配置 Rerank 模型的 API 祕鑰之後，在檢索設置中打開“Rerank 模型”，系統會在全文檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設置 Rerank 模型後，TopK 和 Score 閾值設置僅在 Rerank 步驟生效。

### **混合檢索**

同時執行全文檢索和向量檢索，並應用重排序步驟，從兩類查詢結果中選擇匹配用戶問題的最佳結果，需配置 Rerank 模型 API。

<figure><img src="../../../.gitbook/assets/image (169).png" alt="" width="563"><figcaption><p>混合檢索設置</p></figcaption></figure>

**TopK：** 用於篩選與用戶問題相似度最高的文本片段。系統同時會根據選用模型上下文窗口大小動態調整片段數量。系統默認值為 3 。

**Rerank 模型：** 你可以在“模型供應商”頁面配置 Rerank 模型的 API 祕鑰之後，在檢索設置中打開“Rerank 模型”，系統會在混合檢索後對已召回的文檔結果再一次進行語義重排序，優化排序結果。設置 Rerank 模型後，TopK 和 Score 閾值設置僅在 Rerank 步驟生效。

### 創建數據集時設置檢索模式

進入“數據集->創建數據集”頁面並在檢索設置中設置不同的檢索模式：

<figure><img src="../../../.gitbook/assets/image (170).png" alt="" width="563"><figcaption><p>創建數據集時設置檢索模式</p></figcaption></figure>

### 數據集設置中修改檢索模式

進入“數據集->選擇數據集->設置”頁面中可以對已創建的數據集修改不同的檢索模式。

<figure><img src="../../../.gitbook/assets/image (171).png" alt="" width="563"><figcaption><p>數據集設置中修改檢索模式</p></figcaption></figure>

### 提示詞編排中修改檢索模式

進入“提示詞編排->上下文->選擇數據集->設置”頁面中可以在創建應用時修改不同的檢索模式。

<figure><img src="../../../.gitbook/assets/image (172).png" alt=""><figcaption><p>提示詞編排中修改檢索模式</p></figcaption></figure>
